var readSMS = 0;
var pwa = 'web';
var tryCount = 0;
var uagent = navigator.userAgent;
var domain = window.location.hostname;
var testing = 0;
var truecallerRequestId = '';
var pollingCount = 0;


var cMappingId;

if (uagent.indexOf('AppContainer') !== -1) {
    pwa = 'paytm';
    $('.paymentsBlock').hide();
    $('.linkBlock').hide();
    document.getElementById('truecallerBTN').style.display = 'none';
    document.getElementById('truecallerOr').style.display = 'none';
    if (document.getElementById("foot") != null) {
        document.getElementById("foot").innerHTML = "Made with Love in India by <a style='color:#fff'> Uengage</a>";
    }

}

function scrollFunction() {
    var mybutton = document.getElementById("myBtn");
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        mybutton.style.display = "block";
    } else {
        mybutton.style.display = "none";
    }
}
if (document.querySelector('.wrapper-menu')) {
    var wrapperMenu = document.querySelector('.wrapper-menu');

    wrapperMenu.addEventListener('click', function() {
        wrapperMenu.classList.toggle('open');
    });

}

if ('OTPCredential' in window) {
    window.addEventListener('DOMContentLoaded', e => {
        // alert("hhhh"); 
        const pId = "<?php echo $pId;?>";
        const input = document.querySelector('input[autocomplete="one-time-code"]');
        if (!input) return;
        const ac = new AbortController();
        //      const form = input.closest('form');
        //      if (form) {
        //        form.addEventListener('submit', e => {
        //          ac.abort();
        // alert
        //        });
        // }
        // alert(pId);
        // alert(pId);
        if (readSMS == 1) {
            navigator.credentials.get({
                otp: {
                    transport: ['sms']
                },
                signal: ac.signal
            }).then(otp => {
                // alert(pId);
                // alert(otp.code);
                input.value = otp.code;
                validateOTP(pId);
                //  if (form) form.submit();
                // console.log(otp);
            }).catch(err => {
                console.log(err);
            });
        }

    });
}

$(document).ready(function() {

    // window.onscroll = function() {scrollFunction()};

    $(".search-btn").click(function() {
        $("#search-bar").slideToggle("fast");
        $('#searchText').focus();
    });

    $("section").click(function() {
        $(".navbar-collapse").removeClass("show");

    });

    $("section").click(function() {
        $(".wrapper-menu").removeClass("open");
    });

    // $(".nav-icon").click(function(){
    //    $(this).toggleClass("nav-icon-active")
    // });

    $(".btn-left-menu").click(function() {
        $(".left-panel").css("height", "100%");
    });
    $(".menu-close").click(function() {
        $(".left-panel").css("height", "0");
    });



    // $(".od-right .order-option a").click(function(e){
    //    $(".order-option a").removeClass("active");
    //    $(this).addClass("active");
    // });
    $('.qty-increase').click(function(e) {
        e.preventDefault();
        var quantity = parseInt($('#qty-input').val());
        $('#qty-input').val(quantity + 1);
        $(".price").text(price * 2);
    });
    $('.qty-decrease').click(function(e) {
        e.preventDefault();
        var quantity = parseInt($('#qty-input').val());
        if (quantity > 0) {
            $('#qty-input').val(quantity - 1);
        }
    });
});



(function(window, $) {
    $(function() {
        $('.btn').on('click', function(event) {
            // event.preventDefault();
            var $btn = $(this),
                $div = $('<div/>'),
                btnOffset = $btn.offset(),
                xPos = event.pageX - btnOffset.left,
                yPos = event.pageY - btnOffset.top;
            $div.addClass('ripple-effect');
            $div
                .css({
                    height: $btn.height(),
                    width: $btn.height(),
                    top: yPos - ($div.height() / 2),
                    left: xPos - ($div.width() / 2),
                    background: $btn.data("ripple-color") || "#fff"
                });
            $btn.append($div);
            window.setTimeout(function() {
                $div.remove();
            }, 2000);
        });
    });
})(window, jQuery);


$(document).ready(function() {


    if (typeof(Storage) !== "undefined") {
        if (!localStorage.getItem('userdata') || localStorage.getItem('userdata') == '') {
            $('#lgBtn').show();
            $('.accountdvlogin').show();
            $('#welLgBTN').hide();
            $('.accountdv').hide();
        } else {
            $('#lgBtn').hide();
            $('.accountdvlogin').hide();
            var userData = JSON.parse(localStorage.getItem('userdata'));
            $('#welLgBTN').show();
            $('.accountdv').show();
            //  $('#welLgBTN').html('Welcome '+userData.name)

        }
    } else {
        $('#lgBtn').show();
        $('.accountdvlogin').show();
    }

});




// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    $('html,body').animate({ scrollTop: 0 }, 'slow');

}

function openLogin() {
    if (pwa == 'paytm') {
        //   alert("paytm");
        tryCount = 0;
        paytmLogin();
    } else {
        $('#mobileNo').val('');
        $('#validateOTP, #OTP').hide();
        $('#sendOTP').show();
        $('#OTP').val('');
        $('#resendOTP').hide();

        $('#loginModal').modal({ backdrop: 'static', keyboard: false })
    }

}

function checkLogin(ecomm, cBID) {
    if (!localStorage.getItem('userdata') || localStorage.getItem('userdata') == '') {
        openLogin();
        return;
    } else {
        if (ecomm == 1) {
            var url = window.location.origin + "/checkout/" + cBID + "/1";
            window.location.href = url;
            return;
        }

    }

}

$('#mobileNo, #OTP').keypress(function(e) {
    return isNumber(e);
});

function sendOTP(pId) {
    var mobileNo = $('#mobileNo').val();
    if (mobileNo == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter Mobile number.");
        errormodalhide();
        return false;
    }

    if (mobileNo.length != 10) {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Mobile number should be 10 digits only.");
        errormodalhide();
        return false;
    }
    var origin = window.location.origin;
    var url = origin + "/client/login/" + mobileNo + "/" + pId;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {
                $('#verifyotp').modal('hide');
                $('#promonotapplied').modal('show');
                $('#promonotmsg').html(result['msg']);
                errormodalhide();
                return false;
            } else {
                readSMS = 1;
                $('#enter_number').html(mobileNo);
                $('#verifyotp').modal('show');
                $('#validateOTP').show();
                $('#sendOTP').hide();
                $('#OTP').show();
                $('#truecallerOr').hide();
                $('#truecallerBTN').hide();
                //$('#mobileNo').attr('readonly',true);
                $('#promoapplied').modal('show');
                $('.promors').html(result['msg']);
                setTimeout(function() {
                    $('#promoapplied').modal('hide')
                }, 2500);
                
                // $('#closeLoginModal').hide();
                //setTimeout(function() { $('#resendOTP').show(); }, 60000);
            }
        }
    });
}

function sendEmailOTP(pId) {
    var email_Id = $('#email_Id').val();
    if (email_Id == '') {
        //   showAlert('');
        $('#errorMessageLogin').html('');
        $('#errorMessageLogin').html("Kindly Enter Valid Email Id");
        $("#danger-alert-login").fadeTo(2000, 500).slideUp(500, function() {
            $("#danger-alert-login").slideUp(500);
        });
        return false;
        //   return false;
    }
    var origin = window.location.origin;
    var url = origin + "/email_login/login?email=" + email_Id + "&businessId=" + pId;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {
                //   showAlert();
                $('#errorMessageLogin').html('');
                $('#errorMessageLogin').html(result['msg']);
                $("#danger-alert-login").fadeTo(2000, 500).slideUp(500, function() {
                    $("#danger-alert-login").slideUp(500);
                });
                return false;
            } else {
                $('#validateEmail').show();
                $('#sendEmailOTP').hide();
                cMappingId = result['contactIdMappingId'];
                if (result['new_user'] == 1) {
                    $('#validateOTPEmail').show();
                    $('#EmailOTP').show();


                } else {
                    $('#validatePassword').show();
                    $('#EmailPassword').show();

                }

                // $('#closeLoginModal').hide();
                //setTimeout(function() { $('#resendOTP').show(); }, 60000);
            }
        }
    });
}

function resendOTP(pId) {
    var mobileNo = $('#mobileNo').val();
    if (mobileNo == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter Mobile number.");
        errormodalhide();
        return false;
    }

    if (mobileNo.length != 10) {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Mobile number should be 10 digits only.");
        errormodalhide();
        return false;
    }
    var mobileNo = $('#mobileNo').val();
    var origin = window.location.origin;
    var url = origin + "/client/login/" + mobileNo + "/" + pId;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {
                $('#promonotapplied').modal('show');
                $('#promonotmsg').html(result['msg']);
                errormodalhide();
                return false;
            } else {

                $('#promoapplied').modal('show');
                $('.promors').html(result['msg']);
                setTimeout(function() {
                    $('#promoapplied').modal('hide')
                }, 2500);
                
                $('#resendOTP').hide();
                //setTimeout(function() { $('#resendOTP').show(); }, 60000);
            }
        }
    });

}

function errormodalhide() {
    setTimeout(function() {
        $('#promonotapplied').modal('hide')
    }, 2500);
}

function validateOTP(pId) {

    if (window.SMS) {
        document.addEventListener('onSMSArrive', function(e) {
          var sms = e.data;
          // Check if the SMS message contains an OTP code
          var otpRegex = /(\d{6})/;
          var match = sms.body.match(otpRegex);
          if (match) {
            // Fill the input fields with the OTP code
            var code = match[1];
            $('#codeBox1').val(code[0]);
            $('#codeBox2').val(code[1]);
            $('#codeBox3').val(code[2]);
            $('#codeBox4').val(code[3]);
            $('#codeBox5').val(code[4]);
            $('#codeBox6').val(code[5]);
          }
        });
      }

    var mobileNo = $('#mobileNo').val();
    var OTP = '';
    $('.passcode-wrapper input').each(function() {
        OTP += $(this).val();
    });
    //var OTP = $('#OTP').val();
    if (mobileNo == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter Mobile number.");
        errormodalhide();
        return false;
    }

    if (mobileNo.length != 10) {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Mobile number should be 10 digits only.");
        errormodalhide()
        return false;
    }

    if (OTP == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter OTP.");
        errormodalhide();
        return false;
    }

    if (OTP.length != 6) {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("OTP should be 6 digits only.");
        errormodalhide()
        return false;
    }


    var origin = window.location.origin;
    var url = origin + "/client/validateMobileByOTP/" + mobileNo + "/" + OTP + "/" + pId;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {

                $('#promonotapplied').modal('show');
                $('#promonotmsg').html(result['msg']);
                errormodalhide()
                return false;
            } else {
                $('#promoapplied').modal('show');
                $('.promors').html(result['msg']);
                setTimeout(function() {
                    $('#promoapplied').modal('hide')
                }, 2500);
                

                readSMS = 0;
                var userdata = {
                        contactId: result['rows']['contactId'],
                        token: result['rows']['token'],
                        contactMappingId: result['rows']['contactMappingId'],
                        mobile: mobileNo,
                        name: result['rows']['name'],
                        email: result['rows']['email'],
                        dob: result['rows']['dob']
                    }
                    // userdata=;
                localStorage.setItem('userdata', JSON.stringify(userdata));
                localStorage.setItem('token', userdata.token);
                $('#loginModal').modal('hide');
                $('#verifyotp').modal('hide');
                $('#mobileNo').val('');
                $('#validateOTP, #OTP').hide();
                $('#sendOTP').show();
                $('#OTP').val('');
                $('#resendOTP').hide();
                $('#verifyotp').hide();
                $('#menu-total').show();
                $('#loginBTN').hide();
                $('#cartBTN').show();
                $('#loginDIV').hide();
                $('#lgBtn').hide();
                $('.accountdvlogin').hide();
                $('#cartArea').show();
                $('#welLgBTN').show();
                $('.accountdv').show();

                document.getElementById("namevalue").innerText = result['rows']['name'];
                document.getElementById("emailvalue").innerText = result['rows']['email'];

               

                if (result['rows']['name'] == '' || result['rows']['name'] == null || result['rows']['name'] == 'user' || result['rows']['name'] == 'User') {
                    if (result['rows']['email'] != null && result['rows']['email'] != 'null' && result['rows']['email'] != '') {
                        $('#uEmail').val(userData['email']);
                    }
                    $('#updateProfileModal_new').modal({ backdrop: 'static', keyboard: false });
                }

                if (window.location.pathname.indexOf("nps") > -1) {
                    checkFormSubmitted();
                }


                if (window.location.href.indexOf("order") > -1 || window.location.href.indexOf("products") > -1) {
                    add_to_cart('add', '');
                }
                if (window.location.href.indexOf("checkout") > -1) {
                    add_to_cart_login();
                    location.reload();
                }
            }
        }
    });
}

function validateEmailOTP(pId) {

    var OTP = $('#EmailOTP').val();
    if (OTP == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter OTP.");
        errormodalhide();
    }
    var origin = window.location.origin;
    var url = origin + "/email_login/verifyotp?contactMappingId=" + cMappingId + "&otp=" + OTP;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {

                $('#promonotapplied').modal('show');
                $('#promonotmsg').html(result['msg']);
                errormodalhide();
            } else {
                var userdata = {
                        contactId: result['rows']['contactId'],
                        token: result['rows']['token'],
                        contactMappingId: result['rows']['contactMappingId'],
                        mobile: '',
                        name: result['rows']['name'],
                        email: result['rows']['email'],
                        dob: result['rows']['dob']
                    }
                    // userdata=;
                localStorage.setItem('userdata', JSON.stringify(userdata));
                localStorage.setItem('token', userdata.token);
                $('#loginModal').modal('hide');
                $('#menu-total').show();
                $('#loginBTN').hide();
                $('#cartBTN').show();
                $('#loginDIV').hide();
                $('#lgBtn').hide();
                $('.accountdvlogin').hide();
                $('#cartArea').show();
                $('#welLgBTN').show();
                $('.accountdv').show();
                $('#updateProfileModal').modal({ backdrop: 'static', keyboard: false })

                document.getElementById("namevalue").innerText = result['rows']['name'];
                document.getElementById("emailvalue").innerText = result['rows']['email'];

                if (window.location.href.indexOf("order") > -1 || window.location.href.indexOf("products") > -1) {
                    add_to_cart('add', '');
                }
            }
        }
    });
}

function verifyPassword(pId) {
    // var email_Id=$('#email_Id').val();
    var EmailPassword = encodeURIComponent($('#EmailPassword').val());
    var origin = window.location.origin;
    var url = origin + "/email_login/verifypassword?contactMappingId=" + cMappingId + "&password=" + EmailPassword + "&businessId=" + pId;
    $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function(result) {
            if (result['status'] == 0) {

                $('#errorMessageLogin').html('');
                $('#errorMessageLogin').html(result['msg']);
                $("#danger-alert-login").fadeTo(2000, 500).slideUp(500, function() {
                    $("#danger-alert-login").slideUp(500);
                });
                return false;
            } else {
                // readSMS=0;
                var userdata = {
                        contactId: result['rows']['contactId'],
                        token: result['rows']['token'],
                        contactMappingId: result['rows']['contactMappingId'],
                        mobile: '',
                        name: result['rows']['name'],
                        email: result['rows']['email'],
                        dob: result['rows']['dob']
                    }
                    // userdata=;
                localStorage.setItem('userdata', JSON.stringify(userdata));
                localStorage.setItem('token', userdata.token);
                $('#loginModal').modal('hide');
                $('#menu-total').show();
                $('#loginBTN').hide();
                $('#cartBTN').show();
                $('#loginDIV').hide();
                $('#lgBtn').hide();
                $('.accountdvlogin').hide();
                $('#cartArea').show();
                $('#welLgBTN').show();
                $('.accountdv').show();
                if (window.location.href.indexOf("order") > -1 || window.location.href.indexOf("products") > -1) {
                    add_to_cart('add', '');
                }
            }
        }
    });
}


function updateProfileEmail(pId) {
    if ($('#EUpdateName').val() == '') {
        alert("Name is Mandatory!");
        return false;
    }
    if ($('#EUpdatePassword').val() == '') {
        alert("Password is Mandatory!");
        return false;
    }
    var userData = JSON.parse(localStorage.getItem('userdata'));
    var params = 'contactMappingId=' + userData['contactMappingId'] +
        '&businessId=' + pId + '&name=' + $('#EUpdateName').val() + '&password=' + $('#EUpdatePassword').val();

    var origin = window.location.origin;
    $.ajax({
        type: 'POST',
        url: origin + "/email_login/addinfo?" + params,
        // data	: {"email":value},
        dataType: "json",
        headers: { 'token': userData['token'] },
        async: false

    }).done(function(response) {
        if (response['status'] == 1) {
            var userData = JSON.parse(localStorage.getItem('userdata'));
            userData['name'] = $('#EUpdateName');
            localStorage.setItem('userdata', JSON.stringify(userData));
            $('#updateProfileModal').modal('hide');

        }

    });
}

function validateEmail($email) {
    var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
    return emailReg.test($email);
}

$(".tspace").on("keyup", function() {
    var length = $.trim($(this).val()).length;
    if (length == 0) {
        $(this).val("");
    } else {
        $(this).val($(this).val().trimLeft(""));
    }
})

$('.block-start-space').keypress(function(e) {
    if ($(this).val() == '') {
        if (!/[0-9a-zA-Z-]/.test(String.fromCharCode(e.which)))
            return false;
    }
})

$(document).on('keydown', '#uEmail', function(e) {
    if (e.which === 32) {
        return false;
    }
});

function isNumber(evt) {
    let iKeyCode = (evt.which) ? evt.which : evt.keyCode
    if (iKeyCode != 46 && iKeyCode > 31 && (iKeyCode < 48 || iKeyCode > 57))
        return false;

    return true;
}

// trim space
$(".block-start-space").on("keyup", function() {
    var length = $.trim($(this).val()).length;
    if (length == 0) {
        $(this).val("");
    } else {
        $(this).val($(this).val().trimLeft(""));
    }
})


function uProfileUpdate(pId) {
    if ($('#FullName').val() == '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please Enter Full Name");
        errormodalhide();
        return false;
    }

    var emailId = $('#EmailAddress').val();

    if (validateEmail(emailId) == false && emailId != '') {
        $('#promonotapplied').modal('show');
        $('#promonotmsg').html("Please enter valid Email Address");
        errormodalhide();
        return false;
    }

    var gender = '';
    if ($('input[name="gender"]:checked').val() != undefined) {
        gender = $('input[name="gender"]:checked').val();
    }
    var dob = '';
    if ($('#DateOfBirth').val() != undefined) {
        dob = $('#DateOfBirth').val();
    }
    var married = '';
    var anniversary = '';
    if ($('#AniversaryLabel').val() != undefined) {
        anniversary = $('#AniversaryLabel').val();
        married = 1;
    }

    var userData = JSON.parse(localStorage.getItem('userdata'));
    var params = 'contactMappingId=' + userData['contactMappingId'] + '&token=' + userData['token'] +
        '&contactId=' + userData['contactId'] + '&businessId=' + pId + '&name=' + $('#FullName').val() +
        '&email=' + emailId + "&gender=" + gender + "&dob=" + dob + "&married=" + married + "&anniversary=" + anniversary;

    var origin = window.location.origin;
    $.ajax({
        type: 'GET',
        url: origin + "/client/updateProfile?" + params,
        // data	: {"email":value},
        dataType: "json",
        async: false

    }).done(function(response) {
        if (response['status'] == 1) {
            var userData = JSON.parse(localStorage.getItem('userdata'));
            userData['name'] = $('#FullName').val();
            userData['email'] = $('#EmailAddress').val();
            document.getElementById("namevalue").innerText = $('#FullName').val();
            document.getElementById("emailvalue").innerText = $('#EmailAddress').val();
            localStorage.setItem('userdata', JSON.stringify(userData));
            $('#updateProfileModal_new').modal('hide');
            $('#promoapplied').modal('show');
            $('.promors').html(response['msg']);
            setTimeout(function() {
                $('#promoapplied').modal('hide')
            }, 2500);
            if (window.location.href.indexOf("checkout") > -1) {
                openPayment();
            }


        }

    });
}

function showAlert(msg) {
    $('#errorMessage').html('');
    $('#errorMessage').html(msg);
    $("#danger-alert").fadeTo(2000, 500).slideUp(500, function() {
        $("#danger-alert").slideUp(500);
    });
}

function logout() {
    localStorage.clear();
    window.location.href = '/';
}


function searchExpand() {
    var dev = document.getElementById('searchBar');
    var style = window.getComputedStyle(dev);
    if (style.display == 'none') {
        $('#searchBar').show();
        $('#search').focus();
    } else {
        $('#searchBar').hide();
    }

}

function closeSearch() {
    if ($('#search').val() == '') {
        $('#searchBar').hide();
    }

}

function profile() {

    window.location.href = '/profile';
}

function storeCityPage(city) {
    window.location.href = '/store-locator/' + city;
}

function storeDetailsPage(city, slug) {
    window.location.href = '/store-locator/' + city + "/" + slug;
}

function orderPage(slug) {
    window.location.href = '/order/' + slug;
}

function redirectPage(page) {
    window.location.href = page;
}

function call(phoneNo) {
    window.open("tel:" + phoneNo);
}

function truecallerLogin(pId) {
    let requestNonce = pId + '-' + Math.floor(Math.random() * 100000000);; // random number of length 8 to 64 characters
    console.log("hello");
    window.location = "truecallersdk://truesdk/web_verify?" +
        "type=btmsheet&" +
        "requestNonce=" + requestNonce +
        "&partnerKey=" + truecaller_key +
        "&partnerName=" + encodeURI(businessName) +
        "&lang=en&loginPrefix=placeorder&loginSuffix=login&ctaPrefix=proceedwith&ctaColor=%230099ff&ctaTextColor=%23ffffff&btnShape=Round&skipOption=Later";

    setTimeout(function() {

        if (document.hasFocus()) {
            alert("Oops! Truecaller Not Installed");

        } else {
            truecallerRequestId = requestNonce;
            $('#truecallerModal').modal('show');
            getTruecallerLoginStatus();
        }
    }, 600);
}

function paytmLogin() {
    JSBridge.call('paytmFetchAuthCode', {
        clientId: paytm_mId,
    }, function(result) {
        // alert(JSON.stringify(result))
        getPaytmAuthCode(result);
    });
}

function tryPaytmLogin() {
    $('.paytmConsentModal').modal('hide');
    paytmLogin();
}

function popoutPaytm() {
    JSBridge.call('popWindow');
}

function getPaytmAuthCode(res) {
    // alert(JSON.stringify(res));
    if (res['error'] == -1 || res['error'] == -2) {
        // alert(tryCount);
        //  tryCount++;
        //  if(tryCount>3){
        //      JSBridge.call('popWindow');
        //  }else{
        //    //   $('#main-loader1').hide();
        //     $('.paytmConsentModal').modal('show');
        //  }

    } else if (res['error'] != undefined) {
        alert("Unable to Fetch the Login Details");
        setTimeout(function() { window.location.href = "#/home-feed"; }, 1700);
    } else {
        // alert("https://www.uengage.in/client/getAuthCodePaytm"+pId);
        //  $('#main-loader1').show();
        $.ajax({
            type: 'GET',
            url: "https://www.uengage.in/client/getAuthCodePaytm/" + pId,
            data: {
                "authCode": JSON.stringify(res)
            },
            async: false

        }).done(function(data) {
            //  alert(data)
            data = JSON.parse(data);

            //   $('#main-loader1').hide();
            if (data.status == 1) {
                var userdata = {
                        contactId: data.rows.contactId,
                        token: data.rows.token,
                        contactMappingId: data.rows.contactMappingId,
                        mobile: data.rows.mobileNo,
                        name: data.rows.name,
                        email: data.rows.email
                    }
                    // alert(data.rows.name);
                    // var db1 = getLocalStorage();
                localStorage.setItem('userdata', JSON.stringify(userdata));
                localStorage.setItem('token', userdata.token);
                // $('#main-loader1').hide();
                $('#loginModal').modal('hide');
                $('#menu-total').show();
                $('#loginBTN').hide();
                $('#cartBTN').show();
                $('#loginDIV').hide();
                $('#lgBtn').hide();
                $('.accountdvlogin').hide();
                $('#cartArea').show();
                $('#welLgBTN').show();
                $('.accountdv').show();
                if (window.location.href.indexOf("order") > -1) {
                    if (pId == 6156) {
                        add_to_cart('add', '');
                    } else {
                        add_to_cart('view', '');
                    }

                }
            } else {
                JSBridge.call('popWindow');
                // window.location.href = "https://pwa.uen.io/#/login";
            }

        });
    }
}

function getEmailId(userdata) {
    swal("Kindly enter the Email Id:", {
            content: "input",
        })
        .then((value) => {
            // alert(value);
            if (value == '') {
                swal({
                    title: "Login is mandatory to proceed?",
                    icon: "warning",
                    buttons: false,
                    timer: 1500
                })
                getEmailId(userdata);
            } else {

                var businessId = "5";
                var params = 'contactId=' + userdata.contactId + '&contactMappingId=' + userdata.contactMappingId +
                    '&businessId=' + businessId + '&token=' + userdata.token;
                // alert(params);
                $.ajax({
                    type: 'POST',
                    url: "https://www.uengage.in/client/updateProfile?" + params,
                    data: { "email": value },
                    // headers : {'Content-Type': 'application/x-www-form-urlencoded'},
                    async: false

                }).done(function(response) {
                    // alert("ss");
                    // alert(response);
                    data = JSON.parse(response);
                    // alert(data);
                    $scope.loading = false;

                    if (response.data.status == 0) {

                        if (response.data.msg == 'Invalid Token') {
                            $location.path('/logout');
                        }

                    } else {
                        swal({
                            title: "Successfully Updated",
                            text: response.data.msg,
                            timer: 1500,
                            button: false,
                            showConfirmButton: false,
                            icon: "success"
                        });
                        var db1 = getLocalStorage();
                        userdata.email = value;
                        //   alert(userdata);
                        db1.setItem('userdata', JSON.stringify(userdata));
                        $('#main-loader1').hide();
                    }


                });
            }
        });
}


function getTruecallerLoginStatus() {

    if (pollingCount == 10) {
        closePolling();
        // alert("Oops! Not Able to fetch the Details");
        $('#truecallerModal').modal('hide');
        return false;
    } else {
        $.ajax({
            type: 'GET',
            url: "https://" + domain + "/client/getTrueCallerStatus",
            data: {
                "requestId": truecallerRequestId,
                "pId": pId
            },
            async: false

        }).done(function(data) {
            data = JSON.parse(data);
            if (data.status == 1) {
                $('#truecallerModal').modal('hide');
                closePolling();
                var userdata = {
                        contactId: data.rows.contactId,
                        token: data.rows.token,
                        contactMappingId: data.rows.contactMappingId,
                        mobile: data.rows.mobileNo,
                        name: data.rows.name,
                        email: data.rows.email
                    }
                    // alert(data.rows.name);
                    // var db1 = getLocalStorage();
                localStorage.setItem('userdata', JSON.stringify(userdata));
                localStorage.setItem('token', userdata.token);
                $('#loginModal').modal('hide');
                $('#menu-total').show();
                $('#loginBTN').hide();
                $('#cartBTN').show();
                $('#loginDIV').hide();
                $('#lgBtn').hide();
                $('.accountdvlogin').hide();
                $('#cartArea').show();
                $('#welLgBTN').show();
                $('.accountdv').show();
                if (window.location.href.indexOf("order") > -1) {
                    add_to_cart('add', '');
                }

                $("#success-alert-truecaller").fadeTo(2000, 500).slideUp(500, function() {
                    $("#success-alert-truecaller").slideUp(500);
                });


            } else if (data.status == -1) {
                closePolling();
                $('#truecallerModal').modal('hide');
                return false;

            } else {
                pollingCount++;
                setTimeout(function() {
                        getTruecallerLoginStatus();
                    },
                    1000);
            }
        });
    }
}




function closePolling() {
    pollingCount = 0;
    truecallerRequestId = '';
}



function searchOutletViaPincode(pId) {
    var pincode = $('.pincodeArea').val();
    if (pincode == '' || pincode.length < 3) {
        $(".outleterrormsg").html("Please enter 3 digit of postcode or suburb");
        $(".outleterror").fadeTo(2000, 500).slideUp(500, function() {
            $(".outleterror").slideUp(500);
        });
        return false;
    }

    var params = 'areaId=' + pincode + '&parentBusinessId=' + pId;

    $.ajax({
        type: 'GET',
        url: "https://" + domain + "/email_login/GetAssignedBusiness?" + params,
        async: false,
        dataType: "json",

    }).done(function(data) {
        var bName = ''
        if (data['status'] == 1) {
            if (data['data'].length > 0) {
                for (var i = 0; i < data['data'].length; i++) {
                    bName += '<div class="col-md-4"><div class="card-inner">';
                    bName += '<div class="card-top"><h3>' + data['data'][i]['locality'] + ',' + data['data'][i]['locality'] + '</h3></div>';
                    bName += '<div class="card-middle"><ul class="card-uln">';
                    bName += '<li><i class="las la-map-marker"></i></li>';
                    bName += '<li>' + data['data'][i]['address'] + '</li></ul>';
                    bName += '<ul class="card-uln"><li><i class="las la-phone"></i></li><li>' + data['data'][i]['contactNumber'] + '</li></ul>';
                    var orderType = "";
                    if (data['data'][i]['onlineOrdersDelivery'] == 1) {
                        if (orderType == '') {
                            orderType = 'Delivery';
                        }
                    }
                    if (data['data'][i]['onlineOrdersSelfPickup'] == 1) {
                        if (orderType == '') {
                            orderType = 'Pickup';
                        } else {
                            orderType += ',Pickup';
                        }
                    }
                    bName += '<ul class="card-uln"><li><i class="las la-utensils"></i></li><li>' + orderType + '</li></ul>';
                    bName += '</div><div class="card-footerr"><ul class="footer-btns"><li><a href="tel:' + data['data'][i]['contactNumber'] + '">Call</a>';
                    bName += '</li><li><a target="_blank" href="https://www.google.com/maps/@' + data['data'][i]['latitude'] + ',' + data['data'][i]['longitude'] + '">Navigate</a></li>';
                    bName += '<li><a href="https://' + domain + '/order/' + data['data'][i]['slug'] + '" class="redd">order</a></li>';
                    bName += '</ul></div></div></div>';
                }

                $('.businessCards').html(bName);

            } else {
                $('.businessCards').html('<span id="noOutelet">Oops! No Outlet Found Near Area.</span>');
            }
        }


    });

}



if (typeof truecaller_key != "undefined" && truecaller_key != '') {
    // testing=1;
    if (/android/i.test(uagent)) {
        document.getElementById('truecallerBTN').style.display = 'block';
         document.getElementById('truecallerOr').style.display = 'block';
    }

} else {
    // testing=0;
    if (document.getElementById('truecallerBTN')) {
        document.getElementById('truecallerBTN').style.display = 'none';
        document.getElementById('truecallerOr').style.display = 'none';
    }

}


var oPoolingCount = 0;

function checkOrderStatus(orderId, pId) {
    var origin = window.location.origin;
    var userData = JSON.parse(localStorage.getItem('userdata'));
    var contactMappingId = userData['contactMappingId'];
    var token = userData['token'];
    var mobileNo = userData['mobile'];
    var url = origin + "/client/getOrderStatus?contactMappingId=" + contactMappingId + "&mobileNo=" + mobileNo + "&token=" + token + "&parentBusinessId=" + pId + "&orderId=" + orderId;
    $.ajax({
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data) {
            if (data['status'] == 0) {
                if (oPoolingCount != 6) {
                    oPoolingCount++;
                    setInterval(function() { checkOrderStatus(orderId, pId) }, 5000);
                } else {
                    var redirectUrl = origin + "/payment-error/" + data['id'];
                    window.location.href = redirectUrl;
                }
            } else {
                $('.success-warning').hide();
                $('.success-img').show();

                var redirectUrl = origin + "/past-order";
                setTimeout(function() { window.location.href = redirectUrl; }, 3000);



            }
        },
        error: function() {
            alert('error handling here');
        }
    });
}


function isEmail(email) {
    var EmailRegex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return EmailRegex.test(email);
}


$(document).ready(function() {
    $(document).on('click', '.myDiv', function() {
        $('body').addClass('myBackground');
        $('.uengageoverlay').addClass('active');
        $('.sidenav').addClass('active');
    })
    $(document).on('click', '.closebtn', function() {
        $('body').removeClass('myBackground');
        $('.uengageoverlay').removeClass('active');
        $('.sidenav').removeClass('active');
    })
});
$(document).click(function(event) {
    if (!$(event.target).closest(".sidenav,.myDiv").length) {
        $("body").find(".sidenav").removeClass("active");
        $("body").find(".uengageoverlay").removeClass("active");
        $("html").find("body").removeClass("myBackground");
    }
});


if (window.history && window.history.pushState) {
    $('.modal').on('show.bs.modal', function(e) {
        window.history.pushState('forward', null);
    });

    $('.menu-top').on('.top-open.menu', function(e) {
        window.history.pushState('forward', null, './.modal');
    });

    $(window).on('popstate', function() {
        $('.modal').modal('hide');
        //$('.menu-top').hide();
		$(".modal-body").scrollTop(0);
    });
}

$("[data-dismiss='modal']").click(function() {
	$(".modal-body").scrollTop(0);
});

$('a.download-btn').click(function() {
    $(this).blur();
});

/*New Header*/
$("#menu-showhide").click(function() {
    $(".site-nav .navbar-collapse").toggleClass("menu-show");
    $("body").toggleClass("body-overflow");
});
$("#menu-showhide-normal").click(function() {
    $(".site-nav .navbar-collapse").toggleClass("menu-show");
    $("body").toggleClass("body-overflow");
});
$("section").click(function() {
    $(".site-nav .navbar-collapse").removeClass("menu-show");
    $("body").removeClass("body-overflow");
});
/*New Header*/

$(document).ready(function() {
    $(document).on('click', '.animatebtn', function(e) {
        $btn = $(this);
        var $offset = $(this).offset();
        $span = $('<span/>');
        var x = e.pageX - $offset.left
        var y = e.pageY - $offset.top;
        $span.addClass('ripple');
        $span.css({
            top: y + 'px',
            left: x + 'px',
        });
        $btn.append($span);
        window.setTimeout(function() {
            $span.remove();
        }, 2200);
    });

});

/*mobile number validation*/
$("#mobileNo").keyup(function(event) {
    var fieldValue = event.target.value;
    if (fieldValue.length == 10) {
      $(".submit_btn").removeClass("disable");
     } else {
      $(".submit_btn").addClass("disable");
      }    
  });
  /*mobile number validation*/

  /*login modal otp validation js*/
function getCodeBoxElement(index) {
    return document.getElementById('codeBox' + index);
  }
  function onKeyUpEvent(index, event) {
    const eventCode = event.which || event.keyCode;
    if (getCodeBoxElement(index).value.length === 1) {
       if (index !== 6) {
          getCodeBoxElement(index+ 1).focus();
       } else {
          getCodeBoxElement(index).blur();
          // Submit code
       }
    }
    if (eventCode === 8 && index !== 1) {
       getCodeBoxElement(index - 1).focus();
    }
  }
  function onFocusEvent(index) {
    for (item = 1; item < index; item++) {
       const currentElement = getCodeBoxElement(item);
       if (!currentElement.value) {
            currentElement.focus();
            break;
       }
    }
  }
  /*login modal otp validation js*/